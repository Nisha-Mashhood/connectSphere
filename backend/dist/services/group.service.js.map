{"version":3,"file":"group.service.js","sourceRoot":"","sources":["../../src/services/group.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { sendEmail } from \"../utils/email.utils.js\";\r\nimport {\r\n  addMemberToGroup,\r\n  createGroupRepository,\r\n  deleteGroupById,\r\n  deleteGroupRequest,\r\n  deleteGroupRequestsByGroupId,\r\n  findGrouptById,\r\n  findRequestById,\r\n  getAllGrouprequsets,\r\n  // getAllGroups,\r\n  // getGroupDeatilsById,\r\n  getGroupRequestsByAdminId,\r\n  getGroupRequestsByGroupId,\r\n  getGroupRequestsByuserId,\r\n  getGroupRequestById,\r\n  getGroups,\r\n  getGroupsByAdminId,\r\n  getGroupsByGroupId,\r\n  groupDetilsByUserId,\r\n  GroupFormData,\r\n  removeGroupMemberById,\r\n  sendRequestToGroup,\r\n  updateGroupImageRepositry,\r\n  updateGroupPaymentStatus,\r\n  updateGroupReqStatus,\r\n  // updateGroupRequestStatus,\r\n} from \"../repositories/group.repositry.js\";\r\nimport stripe from \"../utils/stripe.utils.js\";\r\nimport { v4 as uuid } from \"uuid\";\r\nimport { findUserById } from \"../repositories/user.repositry.js\";\r\n\r\nexport const createGroupService = async (groupData: GroupFormData) => {\r\n  if (\r\n    !groupData.name ||\r\n    !groupData.bio ||\r\n    !groupData.adminId ||\r\n    !groupData.startDate\r\n  ) {\r\n    throw new Error(\"Missing required fields: name, bio, or adminId\");\r\n  }\r\n\r\n  if (!groupData.availableSlots || groupData.availableSlots.length === 0) {\r\n    throw new Error(\"At least one available slot is required\");\r\n  }\r\n\r\n  // Process data if necessary\r\n  const groupPayload = {\r\n    ...groupData,\r\n    createdAt: new Date(),\r\n  };\r\n\r\n  return await createGroupRepository(groupPayload);\r\n};\r\n\r\n//Get group details using adminId\r\nexport const fetchGroupDetails = async (adminId: string) => {\r\n  try {\r\n    // Fetch groups using the repository\r\n    const groups = await getGroupsByAdminId(adminId);\r\n    return groups;\r\n  } catch (error: any) {\r\n    throw new Error(`Error in service layer: ${error.message}`);\r\n  }\r\n};\r\n\r\n//Get group details using groupId\r\nexport const fetchGroupDetailsService = async (groupId: any) => {\r\n  try {\r\n    // Fetch groups using the repository\r\n    const groups = await getGroupsByGroupId(groupId);\r\n    return groups;\r\n  } catch (error: any) {\r\n    throw new Error(`Error in group fetching: ${error.message}`);\r\n  }\r\n};\r\n\r\n//Get all Groups\r\nexport const fetchGroups = async () => {\r\n  try {\r\n    // Fetch groups using the repository\r\n    const groups = await getGroups();\r\n    return groups;\r\n  } catch (error: any) {\r\n    throw new Error(`Error in service layer: ${error.message}`);\r\n  }\r\n};\r\n\r\n//send requset to the group\r\nexport const requestToJoinGroup = async (groupId: string, userId: string) => {\r\n  return await sendRequestToGroup({ groupId, userId });\r\n};\r\n\r\n//fetch group requset by groupId\r\nexport const fetchGroupRequestsByGroupId = async (groupId: string) => {\r\n  return await getGroupRequestsByGroupId(groupId);\r\n};\r\n\r\n//fetch group requset by AdminId\r\nexport const fetchGroupRequestsByAdminId = async (adminId: string) => {\r\n  return await getGroupRequestsByAdminId(adminId);\r\n};\r\n\r\n//fetch group requset by UserId\r\nexport const fetchGroupRequestsByuserId = async (userId: string) => {\r\n  return await getGroupRequestsByuserId(userId);\r\n};\r\n\r\n//update the status to approved / rejected\r\nexport const modifyGroupRequestStatus = async (\r\n  requestId: string,\r\n  status: \"Accepted\" | \"Rejected\"\r\n) => {\r\n  const request = await findRequestById(requestId);\r\n  if (!request) {\r\n    throw new Error(\"Group request not found.\");\r\n  }\r\n  const group = await findGrouptById(request.groupId);\r\n  if (!group) {\r\n    throw new Error(\"Group not found.\");\r\n  }\r\n\r\n  // Check if the group has space\r\n  if (group.members.length >= group.maxMembers) {\r\n    throw new Error(\"Cannot accept request. Group is full.\");\r\n  }\r\n\r\n  if (status === \"Accepted\") {\r\n    if (group.price > 0) {\r\n      await updateGroupReqStatus(requestId, \"Accepted\");\r\n      return;\r\n    } else {\r\n      // If no payment is required, add user to group and delete request\r\n      await updateGroupReqStatus(requestId, \"Accepted\");\r\n      await addMemberToGroup(\r\n        (group._id as any).toString(),\r\n        (request.userId as any).toString()\r\n      );\r\n      await deleteGroupRequest(requestId);\r\n      return { message: \"User added to group successfully.\" };\r\n    }\r\n  } else if (status === \"Rejected\") {\r\n    return await updateGroupReqStatus(requestId, \"Rejected\");\r\n  }\r\n\r\n  throw new Error(\"Invalid status.\");\r\n};\r\n\r\nexport const processGroupPaymentService = async (\r\n  paymentMethodId: string,\r\n  amount: number,\r\n  requestId: string,\r\n  email: string,\r\n  groupRequestData: { groupId: string; userId: string },\r\n  returnUrl: string\r\n) => {\r\n  // Generate a unique key for this transaction to prevent duplicate charges\r\n  const idempotencyKey = uuid();\r\n\r\n  try {\r\n    // Check if customer already exists, otherwise create one\r\n    let customers = await stripe.customers.list({ email, limit: 1 });\r\n    let customer = customers.data.length > 0 ? customers.data[0] : null;\r\n\r\n    // Create a customer in Stripe with payment_method instead of source\r\n    if (!customer) {\r\n      customer = await stripe.customers.create({\r\n        email,\r\n        payment_method: paymentMethodId,\r\n        invoice_settings: { default_payment_method: paymentMethodId },\r\n      });\r\n    }\r\n\r\n    // // Attach the payment method to the customer\r\n    // await stripe.paymentMethods.attach(paymentMethodId, {\r\n    //   customer: customer.id,\r\n    // });\r\n\r\n    // // Set the payment method as the default\r\n    // await stripe.customers.update(customer.id, {\r\n    //   invoice_settings: {\r\n    //     default_payment_method: paymentMethodId,\r\n    //   },\r\n    // });\r\n\r\n    // Create a PaymentIntent instead of a direct charge\r\n    const paymentIntent = await stripe.paymentIntents.create(\r\n      {\r\n        amount,\r\n        currency: \"inr\",\r\n        customer: customer.id,\r\n        payment_method: paymentMethodId,\r\n        confirm: true,\r\n        description: `Payment for Group Request ID: ${requestId}`,\r\n        receipt_email: email,\r\n        metadata: {\r\n          requestId,\r\n          groupId: groupRequestData.groupId,\r\n          userId: groupRequestData.userId,\r\n        },\r\n         return_url: `${returnUrl}?payment_status=success&request_id=${requestId}`\r\n      },\r\n      { idempotencyKey }\r\n    );\r\n\r\n    // If payment succeeded, update database records\r\n    if (paymentIntent.status === \"succeeded\") {\r\n      // Update group payment status to \"Paid\"\r\n      await updateGroupPaymentStatus(requestId, amount / 100);\r\n\r\n      // Add the user to the group as a member\r\n      await addMemberToGroup(groupRequestData.groupId, groupRequestData.userId);\r\n\r\n      // Delete the group request since payment is completed\r\n      await deleteGroupRequest(requestId);\r\n    }\r\n\r\n    return paymentIntent;\r\n  } catch (error: any) {\r\n    console.error(\"Stripe payment error:\", error);\r\n    throw new Error(error.message || \"Payment processing failed\");\r\n  }\r\n};\r\n\r\nexport const removeMemberFromGroup = async (\r\n  groupId: string,\r\n  userId: string\r\n) => {\r\n  try {\r\n    // Check if the group exists\r\n    const group = await findGrouptById(groupId);\r\n    if (!group) {\r\n      throw new Error(\"Group not found\");\r\n    }\r\n\r\n    // Check if the user exists\r\n    const user = await findUserById(userId);\r\n    if (!user) {\r\n      throw new Error(\"User not found\");\r\n    }\r\n\r\n    // Call the repository function to remove the user\r\n    const updatedGroup = await removeGroupMemberById(groupId, userId);\r\n\r\n    // Compose email details\r\n    const subject = `You have been removed from the group \"${group.name}\"`;\r\n    const text = `Hi ${user.name},\r\n\r\nWe wanted to inform you that you have been removed from the group \"${group.name}\" on ConnectSphere.\r\n\r\nIf you believe this was a mistake or have any questions, feel free to reach out to our support team.\r\n\r\nBest regards,\r\nConnectSphere Team`;\r\n\r\n    // Send email notification\r\n    await sendEmail(user.email, subject, text);\r\n    console.log(`Removal email sent to: ${user.email}`);\r\n\r\n    return updatedGroup;\r\n  } catch (error: any) {\r\n    throw new Error(error.message);\r\n  }\r\n};\r\n\r\nexport const deleteGroupByIdService = async (groupId: string) => {\r\n  // Check if the group exists\r\n  const group = await findGrouptById(groupId);\r\n  if (!group) {\r\n    throw new Error(\"Group not found\");\r\n  }\r\n\r\n  // Delete all related group requests before deleting the group\r\n  await deleteGroupRequestsByGroupId(groupId);\r\n\r\n  // Call the repository function to delete the group\r\n  const deletedGroup = await deleteGroupById(groupId);\r\n  return deletedGroup;\r\n};\r\n\r\n//upload group images\r\nexport const updateGroupImageService = async (\r\n  groupId: string,\r\n  profilePic?: string,\r\n  coverPic?: string\r\n) => {\r\n  const updateData: { profilePic?: string; coverPic?: string } = {};\r\n\r\n  if (profilePic) updateData.profilePic = profilePic;\r\n  if (coverPic) updateData.coverPic = coverPic;\r\n\r\n  return await updateGroupImageRepositry(groupId, updateData);\r\n};\r\n\r\n//Get details of the group for the members of the group\r\nexport const groupDetilsForMembers = async (userId: string) => {\r\n  try {\r\n    const groupDetails = await groupDetilsByUserId(userId);\r\n    if (!groupDetails) {\r\n      throw new Error(\"User is not a member of any of the registered groups\");\r\n    }\r\n    return groupDetails;\r\n  } catch (error) {\r\n    console.error(\"Error in GroupService:\", error);\r\n    throw new Error(\"Error retrieving group details\");\r\n  }\r\n};\r\n\r\n//  get all group requests\r\nexport const fetchAllGroupRequests = async () => {\r\n  return await getAllGrouprequsets();\r\n};\r\n\r\n//  get group request details by request ID\r\nexport const fetchGroupRequestById = async (requestId: string) => {\r\n  return await getGroupRequestById(requestId);\r\n};\r\n"]}