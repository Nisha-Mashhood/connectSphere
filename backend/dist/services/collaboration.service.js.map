{"version":3,"file":"collaboration.service.js","sourceRoot":"","sources":["../../src/services/collaboration.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { sendEmail } from \"../utils/email.utils.js\";\r\nimport {\r\n  createCollaboration,\r\n  createTemporaryRequest,\r\n  deleteMentorRequest,\r\n  findCollabById,\r\n  getCollabDataForMentor,\r\n  getCollabDataForUser,\r\n  getMentorRequestsByMentorId,\r\n  getRequestByUserId,\r\n  updateMentorRequestStatus,\r\n} from \"../repositories/collaboration.repositry.js\";\r\nimport stripe from \"../utils/stripe.utils.js\";\r\nimport { v4 as uuid } from \"uuid\";\r\n\r\nexport const TemporaryRequestService = async (requestData: any) => {\r\n  try {\r\n    const newRequest = await createTemporaryRequest({\r\n      ...requestData,\r\n      paymentStatus: \"Pending\",\r\n      isAccepted: \"Pending\",\r\n    });\r\n    return newRequest;\r\n  } catch (error: any) {\r\n    throw new Error(`Error creating temporary request: ${error.message}`);\r\n  }\r\n};\r\n\r\n// Fetch all requests for a mentor\r\nexport const getMentorRequests = async (mentorId: string) => {\r\n  try {\r\n    const request = await getMentorRequestsByMentorId(mentorId);\r\n    return request;\r\n  } catch (error: any) {\r\n    throw new Error(`Error fetching mentor requests: ${error.message}`);\r\n  }\r\n};\r\n\r\n// Accept a mentor request\r\nexport const acceptRequest = async (requestId: string) => {\r\n  try {\r\n    return await updateMentorRequestStatus(requestId, \"Accepted\");\r\n  } catch (error: any) {\r\n    throw new Error(`Error accepting mentor request: ${error.message}`);\r\n  }\r\n};\r\n\r\n// Reject a mentor request\r\nexport const rejectRequest = async (requestId: string) => {\r\n  try {\r\n    return await updateMentorRequestStatus(requestId, \"Rejected\");\r\n  } catch (error: any) {\r\n    throw new Error(`Error rejecting mentor request: ${error.message}`);\r\n  }\r\n};\r\n\r\n// get requset for the user\r\nexport const getRequsetForUser = async (userId: string) => {\r\n  try {\r\n    return await getRequestByUserId(userId);\r\n  } catch (error: any) {\r\n    throw new Error(`Error in retrieving request: ${error.message}`);\r\n  }\r\n};\r\n\r\n//make payemnt using stripe\r\nexport const processPaymentService = async (\r\n  token: any,\r\n  amount: number,\r\n  requestId: string,\r\n  mentorRequestData: any\r\n) => {\r\n  const idempotencyKey = uuid();\r\n\r\n  try {\r\n    const customer = await stripe.customers.create({\r\n      email: token.email,\r\n      source: token.id,\r\n    });\r\n\r\n    const charge = await stripe.charges.create(\r\n      {\r\n        amount,\r\n        currency: \"inr\",\r\n        customer: customer.id,\r\n        receipt_email: token.email,\r\n        description: `Payment for Request ID: ${requestId}`,\r\n      },\r\n      { idempotencyKey }\r\n    );\r\n\r\n    if (charge.status === \"succeeded\") {\r\n      // Calculate dates\r\n      const startDate = new Date();\r\n      const endDate = new Date(startDate);\r\n      endDate.setDate(startDate.getDate() + 30); // Add 30 days\r\n\r\n      // Create a collaboration document\r\n      await createCollaboration({\r\n        mentorId: mentorRequestData.mentorId,\r\n        userId: mentorRequestData.userId,\r\n        selectedSlot: mentorRequestData.selectedSlot,\r\n        price: amount / 100,\r\n        payment: true,\r\n        isCancelled: false,\r\n        startDate,\r\n        endDate,\r\n      });\r\n\r\n      // Delete the mentor request document\r\n      await deleteMentorRequest(requestId);\r\n    }\r\n\r\n    return charge;\r\n  } catch (error: any) {\r\n    throw new Error(error.message);\r\n  }\r\n};\r\n\r\n//Get collab data for user\r\nexport const getCollabDataForUserService = async (userId: string) => {\r\n  try {\r\n    const collabData = await getCollabDataForUser(userId);\r\n    return collabData;\r\n  } catch (error: any) {\r\n    throw new Error(\r\n      `Error getting collaboration data for user: ${error.message}`\r\n    );\r\n  }\r\n};\r\n\r\n//get collab data for mentor\r\nexport const getCollabDataForMentorService = async (mentorId: string) => {\r\n  try {\r\n    const collabData = await getCollabDataForMentor(mentorId);\r\n    return collabData;\r\n  } catch (error: any) {\r\n    throw new Error(\r\n      `Error getting collaboration data for mentor: ${error.message}`\r\n    );\r\n  }\r\n};\r\n\r\n//Delete collab\r\nexport const removecollab = async (collabId: string) => {\r\n  // Check if the group exists\r\n  const collab = await findCollabById(collabId);\r\n  if (!collab) {\r\n    throw new Error(\"Collab not found\");\r\n  }\r\n\r\n  // Ensure mentorId is an object, not a string\r\n  if (typeof collab.mentorId === \"string\") {\r\n    throw new Error(\"Mentor details are not populated properly.\");\r\n  }\r\n\r\n  // Ensure userId in mentor is an object\r\n  if (typeof collab.mentorId.userId === \"string\") {\r\n    throw new Error(\"Mentor's user details are not populated properly.\");\r\n  }\r\n\r\n  // Ensure userId is an object, not a string\r\n  if (typeof collab.userId === \"string\") {\r\n    throw new Error(\"User details are not populated properly.\");\r\n  }\r\n\r\n  // Extract mentor details\r\n  const mentorEmail = collab.mentorId?.userId?.email;\r\n  const mentorName = collab.mentorId?.userId?.name;\r\n  const userName = collab.userId?.name;\r\n\r\n  if (!mentorEmail) {\r\n    throw new Error(\"Mentor email not found\");\r\n  }\r\n\r\n  // Send cancellation email\r\n  const subject = \"Mentorship Session Cancellation Notice\";\r\n  const text = `Dear ${mentorName},\r\n\r\n  We regret to inform you that your mentorship session with ${userName} has been cancelled.\r\n\r\n  If you have any questions, please contact support.\r\n\r\n  Best regards,\r\n  ConnectSphere Team`;\r\n\r\n  await sendEmail(mentorEmail, subject, text);\r\n\r\n  console.log(`Cancellation email sent to mentor: ${mentorEmail}`);\r\n\r\n  // Delete all related group requests before deleting the group\r\n  //return await deleteCollabById(collabId);\r\n};\r\n"]}